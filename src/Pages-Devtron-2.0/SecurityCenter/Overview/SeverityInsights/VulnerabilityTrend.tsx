import { useMemo, useState } from 'react'

import {
    Chart,
    ChartColorKey,
    GenericSectionErrorState,
    getSelectPickerOptionByValue,
    ProdNonProdSelectValueTypes,
    RELATIVE_TIME_WINDOW_SELECT_OPTIONS,
    RelativeTimeWindow,
    SelectPicker,
    SelectPickerOptionType,
    SelectPickerVariantType,
    SEVERITY_LABEL_MAP,
} from '@devtron-labs/devtron-fe-common-lib'

import { SEVERITY_CHART_COLOR_MAP, SEVERITY_ORDER } from '../constants'
import { useGetVulnerabilityTrend } from '../services'
import { getVulnerabilityTrendTooltip } from './utils'

const VulnerabilityTrend = ({ prodNonProdValue }: { prodNonProdValue: ProdNonProdSelectValueTypes }) => {
    const [timeRange, setTimeRange] = useState<RelativeTimeWindow>(RelativeTimeWindow.LAST_30_DAYS)

    const { isFetching, isError, data, refetch } = useGetVulnerabilityTrend(timeRange, prodNonProdValue)

    const handleTimeRangeChange = ({ value }: SelectPickerOptionType<RelativeTimeWindow>) => {
        setTimeRange(value)
    }

    const { xAxisLabels, datasets } = useMemo(() => {
        const dataPoints = data?.trend ?? []
        const timestamps = dataPoints.map(({ timestampLabel }) => timestampLabel)
        const trendDatasets = SEVERITY_ORDER.reduce<
            { datasetName: string; yAxisValues: number[]; color: ChartColorKey }[]
        >((agg, curr) => {
            agg.push({
                datasetName: SEVERITY_LABEL_MAP[curr],
                yAxisValues: dataPoints.map((dataPoint) => dataPoint[curr] ?? 0),
                color: SEVERITY_CHART_COLOR_MAP[curr],
            })
            return agg
        }, [])

        return { xAxisLabels: timestamps, datasets: trendDatasets }
    }, [data])

    const renderBody = () => {
        if (isFetching) {
            return <div className="h-100 w-100 shimmer" />
        }

        if (isError) {
            return <GenericSectionErrorState reload={refetch} />
        }

        return (
            <Chart
                id="vulnerability-trend-chart"
                type="line"
                xAxisLabels={xAxisLabels}
                datasets={datasets}
                yScaleTitle="Vulnerability Count"
                tooltipConfig={{
                    getTooltipContent: getVulnerabilityTrendTooltip(data?.trend ?? [], timeRange),
                }}
            />
        )
    }

    return (
        <div className="flexbox-col bg__primary border__secondary br-8">
            <div className="flex dc__content-space px-16 py-12 border__secondary--bottom">
                <span className="fs-14 fw-6 lh-1-5 cn-9">Vulnerability Trend</span>
                <div className="flex dc__gap-16">
                    <SelectPicker
                        inputId="vulnerability-trend-time-range-select"
                        options={RELATIVE_TIME_WINDOW_SELECT_OPTIONS}
                        variant={SelectPickerVariantType.COMPACT}
                        value={getSelectPickerOptionByValue(RELATIVE_TIME_WINDOW_SELECT_OPTIONS, timeRange)}
                        onChange={handleTimeRangeChange}
                        isSearchable={false}
                        shouldMenuAlignRight
                        isDisabled={isFetching}
                    />
                </div>
            </div>
            <div className="flex p-16 h-300">{renderBody()}</div>
        </div>
    )
}

export default VulnerabilityTrend
