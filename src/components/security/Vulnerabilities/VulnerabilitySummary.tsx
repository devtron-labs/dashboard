import {
    GenericSectionErrorState,
    SegmentedBarChart,
    SEVERITIES_LABEL_COLOR_MAP,
    SeveritiesDTO,
} from '@devtron-labs/devtron-fe-common-lib'

import { CVEListFilters } from './CVEList/types'
import { useGetVulnerabilitySummary } from './services'

import './styles.scss'

const VulnerabilitySummary = ({ filters }: { filters: Partial<Record<CVEListFilters, string[]>> }) => {
    const { isFetching, isError, data, refetch } = useGetVulnerabilitySummary(filters)

    return !isFetching && isError ? (
        <GenericSectionErrorState subTitle="" reload={refetch} />
    ) : (
        <div className="dc__grid vulnerability-summary-card border__secondary shadow__card--10 br-8">
            {!isFetching && !isError && (
                <div className="p-20 flex column left border__secondary--right dc__gap-4">
                    <span className="fs-24 fw-6 lh-1-5">{(data?.totalVulnerabilities ?? 0).toLocaleString()}</span>
                    <span className="fs-13 fw-4 lh-20">Total vulnerabilities on active deployments</span>
                </div>
            )}
            <SegmentedBarChart
                isLoading={isFetching}
                entities={Object.entries(data?.severityCount || {}).map(([key, value]: [SeveritiesDTO, number]) => ({
                    label: SEVERITIES_LABEL_COLOR_MAP[key].label,
                    value,
                    color: SEVERITIES_LABEL_COLOR_MAP[key].color,
                }))}
                rootClassName="p-20 border__secondary--right"
                countClassName="fs-24 fw-6 lh-1-5"
                labelClassName="fs-13 lh-4 lh-20"
                isProportional
                hideTotal
            />
            <SegmentedBarChart
                isLoading={isFetching}
                entities={[
                    {
                        label: 'Fixable',
                        color: 'var(--G400)',
                        value: data?.fixableVulnerabilities || 0,
                    },
                    {
                        label: 'Not Fixable',
                        color: 'var(--N400)',
                        value: data?.notFixableVulnerabilities || 0,
                    },
                ]}
                rootClassName="p-20"
                countClassName="fs-24 fw-6 lh-1-5"
                labelClassName="fs-13 fw-4 lh-20"
                isProportional
                hideTotal
            />
        </div>
    )
}

export default VulnerabilitySummary
